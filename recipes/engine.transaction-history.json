{
  "engine":"transaction-history",
  "name":"Transaction history engine",
  "cacheTime": "60000",
  "import": "transaction-data",
  "quartz" : {
    "checkTimestampForUpdate/addr/count/offset": [
      "list ${addr}-${symbol}-history-*",
      "void {'array':8} 1",
      "jpar",
      "pick",
      "poke fileName",
      "load",
      "jpar",
      "drop $offset",
      "size",
      "true '>$count' 1 @fail",
      "data $fileName",
      "splt '-' 3",
      "poke timestamp",
      "date 'now'",
      "math '-$timestamp'",
      "done",
      "@fail",
      "done 999999999999"
    ],
    "history": [
      "poke addr $1",
      "poke count $2 12",
      "poke offset $3 0",
      "call checkTimestampForUpdate/$addr/$count/$offset",
      "true '$<${cacheTime}' @returnCachedHistory @retrieve",
      "@retrieve",
      "peek import[0]",
      "flow 'insight' @idx @full",
      "@full",
      "call retrieveLatestTransactions/$addr/$count/$offset",
      "done",
      "@idx",
      "call retrieveNewTransactionIds/$addr/$count/$offset",
      "done",
      "@returnCachedHistory",
      "call getCachedTransactionIds/$1/$count/$offset"
    ],
    "retrieveNewTransactionIds/addr/count/offset": [
      "call getHistory/$addr/$count/$offset",
      "poke idx",
      "fork 'saveNewTransactionIds/$addr/$count/$offset/false'",
      "data $idx",
      "done"
    ],
    "removeFile": [
      "tran .value",
      "burn $ @done @fail",
      "@fail",
      "fail 'Could not remove legacy file.'",
      "@done",
      "done"
    ],
    "removeTransactionFile/addr/type": [
      "data ${addr}-${symbol}-${type}*",      
      "poke tx",
      "seek 1 @fail",
      "list $tx",
      "jpar",
      "each removeFile",
      "@fail",
      "done"
    ],
    "hasIntersection/txs": [
      "isct $txs",
      "void {'array':1} 2",
      "done false",
      "done true"
    ],
    "concatTxs/addr/count/offset/isNew/txs": [
      "fuse $txs",
      "uniq",      
      "call sortIdxByTimestamp",
      "poke idx",
      "void {'array':1} 3",
      "peek idx",
      "jump 2",
      "data $addr-${symbol}-history-*",      
      "list $",
      "poke history",
      "void {'array': 2} 1",
      "data '$4'",
      "flow {true:7} 1",
      "@update",
      "date now",
      "poke timestamp",
      "data $1-${symbol}-history-$timestamp",
      "jump @save",
      "@used",
      "data $history",
      "pick",
      "@save",
      "poke fileName",
      "call removeTransactionFile/$1/history/$idx",
      "data $fileName",
      "save $ $idx",
      "poke count $count 12",
      "poke offset $offset 0",
      "math '$count+$offset'",
      "poke endingIndex",
      "data $idx",
      "pick $offset $endingIndex",
      "poke idx",
      "@done",
      "done $idx"      
    ],
    "mvCachedTxs/addr": [
      "poke txs",
      "pick",
      "poke start",
      "peek txs",
      "pick -1",
      "poke end",
      "data ${addr}-${symbol}-chunk-${start}-${end}",
      "save $ $txs",
      "done"
    ],
    "saveNewTransactionIds/addr/count/offset/isNew": [
      "poke txs",
      "call getCachedTransactionIds/$addr/10000000/0",
      "poke cachedTxs",
      "void {'array':5} 1",
      "call hasIntersection/$txs",
      "flow true @concat 1",
      "data $isNew",
      "flow 0 @update @chunk",
      "@concat",
      "data $cachedTxs",
      "call concatTxs/$addr/$count/$offset/$isNew/$txs",
      "done",
      "@update",
      "data $cachedTxs",
      "call mvCachedTxs/$1",
      "data []",
      "call concatTxs/$addr/$count/$offset/$isNew/$txs",
      "done txs",
      "@chunk",
      "data $txs",
      "call mvCachedTxs/$addr"
    ],
    "sortIdxByTimestamp": [
      "each getTxData",
      "sort ['.timestamp',num,desc]",
      "tran '[].id'"
    ],
    "getTxData": [
      "tran .value",
      "list $-${symbol}-transaction",
      "void {'array':6} 1",
      "pick",
      "load",
      "jpar",
      "done",
      "@fail",
      "done []"
    ],
    "getCachedTransactionIds/addr/count/offset": [
      "math $count+$offset",
      "poke endingIndex",
      "list ${addr}-${symbol}-history-*",      
      "void {'array':6} 1",
      "pick",
      "load",
      "jpar",
      "pick $offset $endingIndex",
      "done",
      "done []"
    ],
    "cacheTransactionData": [
      "tran '.value' 1 4",
      "poke txData",
      "tran '.id' 2 1",
      "fail 'Incorrect transaction data format.'",
      "poke txID",
      "peek txData",
      "call saveTransactionData/$txID",
      "@done",
      "done $txData"
    ],
    "cacheHistory": [
      "poke txs",
      "each reformatTx",
      "each cacheTransactionData/$1",
      "done $txs"
    ]
  }
}
