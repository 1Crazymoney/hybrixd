{
  "engine":"transaction-data",
  "name":"Transaction data history engine",
  "cacheConfirmed": "60000",
  "quartz": {
    "transaction/txID": [
      "poke fileName ${txID}-${symbol}-transaction",
      "seek $fileName @returnCachedHistory @retrieve",
      "@retrieve",
      "call getTransaction/$txID",
      "poke tx",
      "fork 'save/$txID'",
      "done $tx",
      "@returnCachedHistory",
      "list $fileName",
      "void {'array':4} 1",
      "pick",
      "load $",
      "jpar",
      "done",
      "call getTransaction/$txID",
      "poke tx",
      "fork 'save/$1'",
      "done $tx"
    ],
    "confirmed/txID" : [
      "poke fileName ${txID}-${symbol}-transaction",
      "seek $fileName 1 @retrieve",
      "meta $fileName",
      "tran .mod 1 @retrieve",
      "math +$cacheConfirmed",
      "poke timePlusCache",
      "date now",
      "# date returns seconds epoch, while meta timestamp var contains milliseconds!",
      "math *1000",
      "true '$<$timePlusCache' 1 @retrieve",
      "load $fileName",
      "jpar",
      "jump @skipRetrieve",
      "@retrieve",
      "call getTransaction/$txID",
      "poke tx",
      "fork 'save/$txID'",
      "peek tx",
      "@skipRetrieve",
      "tran .confirmed 1 2",
      "done",
      "fail 'Could not get confirmations!'"
    ],
    "save/txID": [
      "poke txData",
      "date now",
      "data '${txID}-${symbol}-transaction'",
      "poke fileName",
      "call removeTransactionFile/$txID/transaction",
      "save $fileName $txData",
      "data $txData",
      "tran .source 1 @fail",
      "poke sourceAddress",
      "data $txData",
      "tran .target 1 @fail",
      "poke targetAddress",
      "data ['$txID']",
      "call saveNewTransactionIds/$sourceAddress/1/1/true",
      "data ['$txID']",
      "call saveNewTransactionIds/$targetAddress/1/1/true",
      "@fail",
      "done $txData"
    ],
    "saveTransactionData/txID": [
      "data $",
      "poke txData",
      "data ${txID}-${symbol}-transaction",
      "poke fileName",
      "call removeTransactionFile/$txID/transaction",
      "save $fileName $txData",
      "done $1"
    ],
    "retrieveLatestTransactions/addr/count_/offset": [
      "data $count_",
      "math '+1'",
      "poke count",
      "call getHistory/$addr/$count/$offset",
      "each reformatTx",
      "sort 'desc' '.timestamp'",
      "poke txs",
      "fork 'cacheHistory/$addr'",
      "data $txs",
      "tran '[].id'",
      "poke idx",
      "fork 'saveNewTransactionIds/$addr/$count/$offset/false'",
      "peek idx",
      "test '$count>12' 2 3",
      "#TODO: find proper workaround",
      "drop -1",
      "done"
    ],
    "message/txID" : [
      "poke fileName ${txID}-${symbol}-message",
      "seek $fileName 1 @retrieve",
      "load $fileName",
      "jump @done",
      "@retrieve",
      "call getMessage/$txID",
      "poke message",
      "save $fileName $message",
      "peek message",
      "@done",
      "done"
    ]
  }
}
